<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Orygen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    :root {
      color-scheme: light;
      --bg-gradient-start: #ffffff;
      --bg-gradient-end: #f5f5f5;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: rgba(15, 23, 42, 0.08);
      --card-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --text-primary: #1f2933;
      --text-secondary: rgba(31, 41, 51, 0.68);
      --surface: rgba(255, 255, 255, 0.92);
      --surface-hover: rgba(255, 255, 255, 0.98);
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Titillium Web", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 0.82rem;
      background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.25), transparent 48%) fixed,
                  radial-gradient(circle at top right, rgba(249, 168, 37, 0.18), transparent 45%) fixed,
                  linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 24px 64px;
    }

    body.auth-mode {
      align-items: center;
      padding: 0;
    }

    .app {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .auth {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.24), rgba(255, 255, 255, 0.96));
      backdrop-filter: blur(16px);
      z-index: 900;
    }

    .auth[hidden] {
      display: none !important;
    }

    .auth-card {
      width: min(420px, 100%);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 28px 60px rgba(15, 23, 42, 0.12);
      display: grid;
      gap: 14px;
    }

    .auth-logo {
      width: min(300px, 75%);
      margin: 0 auto 12px;
      display: block;
      object-fit: contain;
      filter: drop-shadow(0 10px 26px rgba(249, 115, 22, 0.3));
    }

    .auth-card h1 {
      margin: 0;
      text-align: center;
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text-primary);
    }

    .auth-card p {
      margin: 0 0 8px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.74rem;
    }

    .auth-card label {
      font-size: 0.74rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .auth-card input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(249, 115, 22, 0.4);
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-primary);
      font-size: 0.86rem;
      outline: none;
      transition: border-color 180ms ease, box-shadow 180ms ease;
    }

    .auth-card input:focus {
      border-color: rgba(249, 115, 22, 0.75);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.26);
    }

    .auth-card button {
      margin-top: 6px;
      padding: 12px 18px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.95), rgba(234, 88, 12, 0.95));
      color: #ffffff;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 18px 36px rgba(249, 115, 22, 0.28);
      transition: transform 180ms ease, box-shadow 180ms ease;
    }

    .auth-card button:hover {
      transform: translateY(-2px);
      box-shadow: 0 24px 44px rgba(249, 115, 22, 0.45);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 22px 26px;
      background: var(--surface);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: 22px;
      box-shadow: var(--card-shadow);
    }

    header .brand {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logout-button {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(249, 115, 22, 0.45);
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.18), rgba(234, 88, 12, 0.18));
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.72rem;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(249, 115, 22, 0.18);
      transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
    }

    .logout-button:hover {
      transform: translateY(-1px);
      border-color: rgba(249, 115, 22, 0.65);
      box-shadow: 0 16px 32px rgba(249, 115, 22, 0.26);
    }

    header img {
      width: 110px;
      height: 110px;
      object-fit: contain;
      filter: drop-shadow(0 12px 24px rgba(249, 115, 22, 0.35));
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.1rem, 1.5vw, 1.5rem);
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 4px 0 0;
      color: var(--text-secondary);
      font-weight: 300;
      font-size: 0.78rem;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
    }

    .summary-card {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      position: relative;
      overflow: hidden;
      transition: transform 220ms ease, box-shadow 220ms ease;
    }

    .summary-card::after {
      content: "";
      position: absolute;
      inset: -200% -40% auto;
      height: 60%;
      background: radial-gradient(circle, rgba(249, 115, 22, 0.24), transparent 65%);
      transition: transform 400ms ease;
      transform: translateY(30%);
    }

    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.38);
    }

    .summary-card:hover::after {
      transform: translateY(20%);
    }

    .summary-card h3 {
      margin: 0;
      font-size: 0.72rem;
      font-weight: 400;
      color: var(--text-secondary);
    }

    .summary-card .value {
      margin-top: 14px;
      font-size: clamp(1.05rem, 1.4vw, 1.4rem);
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .summary-card .trend {
      margin-top: 4px;
      font-size: 0.7rem;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .summary-card.alert {
      border-color: rgba(249, 115, 22, 0.45);
      box-shadow: 0 18px 42px rgba(249, 115, 22, 0.25);
    }

    .alert-list {
      margin: 12px 0 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 8px;
      font-size: 0.68rem;
      color: var(--text-secondary);
    }

    .alert-list li {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(249, 115, 22, 0.1);
    }

    .alert-list li strong {
      font-weight: 600;
      color: var(--text-primary);
    }

    .panel {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 22px;
      padding: 22px 26px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .panel header {
      background: none;
      border: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .panel header h2 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .panel header span {
      margin-top: 6px;
      color: var(--text-secondary);
      font-weight: 300;
      font-size: 0.72rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 18px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.9);
    }

    thead {
      background: rgba(249, 115, 22, 0.08);
      backdrop-filter: blur(4px);
    }

    th, td {
      padding: 10px 12px;
      text-align: left;
      font-size: 0.74rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
    }

    tbody tr {
      transition: background 180ms ease, transform 180ms ease;
    }

    tbody tr:hover {
      background: var(--surface-hover);
      transform: translateY(-1px);
    }

    .link-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(249, 115, 22, 0.32);
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.16), rgba(234, 88, 12, 0.16));
      color: #1f2933;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.7rem;
      transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
      box-shadow: 0 12px 18px rgba(249, 115, 22, 0.18);
    }

    .link-button:hover {
      transform: translateY(-2px);
      border-color: rgba(249, 115, 22, 0.6);
      box-shadow: 0 20px 32px rgba(249, 115, 22, 0.28);
    }

    .progress {
      width: 100%;
      height: 8px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.12);
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar {
      height: 100%;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.9), rgba(234, 88, 12, 0.9));
      transition: width 360ms ease;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 500;
      background: rgba(249, 115, 22, 0.14);
      color: var(--text-secondary);
    }

    .chart-wrapper {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 18px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.35);
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    .spinner {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: grid;
      place-items: center;
      z-index: 1000;
      backdrop-filter: blur(6px);
      transition: opacity 220ms ease;
    }

    .spinner.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner .loader {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 4px solid rgba(148, 163, 184, 0.25);
      border-top-color: var(--accent);
      animation: spin 0.95s linear infinite;
      position: relative;
    }

    .spinner .loader::after {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      border: 3px solid transparent;
      border-top-color: rgba(249, 115, 22, 0.75);
      animation: spin 0.75s linear infinite reverse;
      opacity: 0.8;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 999;
    }

    .toast {
      min-width: 260px;
      padding: 16px 18px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      color: var(--text-primary);
      font-size: 0.9rem;
      display: grid;
      gap: 6px;
      animation: toast-in 420ms ease;
      position: relative;
      overflow: hidden;
    }

    .toast::after {
      content: "";
      position: absolute;
      inset: auto 0 0;
      height: 3px;
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.9), rgba(234, 88, 12, 0.9));
      animation: toast-progress 6s linear forwards;
    }

    .toast strong {
      font-weight: 600;
      font-size: 0.95rem;
    }

    @keyframes toast-in {
      from {
        transform: translateY(10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes toast-progress {
      from {
        width: 100%;
      }
      to {
        width: 0;
      }
    }

    @media (max-width: 1024px) {
      body {
        padding: 32px 16px 48px;
      }

      header {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      header img {
        width: 68px;
        height: 68px;
      }

      table {
        font-size: 0.88rem;
      }

      th, td {
        padding: 14px;
      }
    }

    @media (max-width: 720px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }

      .toast-container {
        right: 50%;
        transform: translateX(50%);
        width: min(320px, 90vw);
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="spinner" id="global-spinner" role="alert" aria-live="polite">
    <div class="loader"></div>
  </div>

  <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <section class="auth" id="auth-screen">
    <form class="auth-card" id="auth-form" autocomplete="off">
      <img class="auth-logo" src="https://goesperu.com/wp-content/uploads/2024/08/771x216.png" alt="Logo GOES Perú">
      <h1>Acceso al Dashboard</h1>
      <p>Ingrese el código de acceso para continuar</p>
      <label for="access-code">Código de acceso</label>
      <input id="access-code" name="access-code" type="password" placeholder="Ingrese el código" required>
      <button type="submit">Ingresar</button>
    </form>
  </section>

  <main class="app" id="dashboard" hidden>
    <header>
      <div class="brand">
        <img src="https://goesperu.com/wp-content/uploads/2024/08/771x216.png" alt="Logo GOES Perú">
        <div>
          <h1>Dashboard de Entregables del Servicio</h1>
          <p>Monitoreo integral de cumplimiento y gestión documental</p>
        </div>
      </div>
      <button type="button" class="logout-button" id="logout-button">Cerrar sesión</button>
    </header>

    <section class="summary-grid" id="metrics-cards">
      <!-- Métricas principales renderizadas por JS -->
    </section>
    <section class="summary-grid" id="alerts-cards">
      <!-- Alertas de cumplimiento renderizadas por JS -->
    </section>

    <section class="panel">
      <header>
        <h2>Histograma de Cumplimiento Global</h2>
        <span>Distribución del porcentaje de cumplimiento por entregable</span>
      </header>
      <div class="chart-wrapper">
        <canvas id="histogramChart" aria-label="Histograma de cumplimiento" role="img"></canvas>
      </div>
    </section>

    <section class="panel">
      <header>
        <h2>Reporte Maestro de Entregables</h2>
        <span>Detalle del plan de entregables con vínculos directos a sus carpetas</span>
      </header>
      <div class="table-wrapper">
        <table>
          <thead id="table-head">
            <!-- Encabezados generados dinámicamente -->
          </thead>
          <tbody id="table-body">
            <!-- Filas generadas dinámicamente -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const SHEET_ID = "1cc53S95H37GG4OjT5Yn7XTGvH6qGQ0ahC8I5QhqQM9Q";
    const SHEET_ENDPOINT = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
    const ACCESS_CODE = "Goes_Orygen_2025";
    const spinner = document.getElementById("global-spinner");
    const toastContainer = document.getElementById("toast-container");
    const authScreen = document.getElementById("auth-screen");
    const dashboardElement = document.getElementById("dashboard");
    const authForm = document.getElementById("auth-form");
    const accessInput = document.getElementById("access-code");
    const logoutButton = document.getElementById("logout-button");
    let histogramChart = null;
    let dashboardLoaded = false;

    const normalizeLabel = (value) => value?.toString().trim().toLowerCase();

    const toast = (title, message, tone = "info") => {
      const toastElement = document.createElement("div");
      toastElement.className = "toast";
      toastElement.innerHTML = `
        <strong>${title}</strong>
        <span>${message}</span>
      `;

      if (tone === "success") {
        toastElement.style.borderColor = "rgba(34, 197, 94, 0.35)";
        toastElement.style.boxShadow = "0 18px 32px rgba(34, 197, 94, 0.25)";
      }

      if (tone === "error") {
        toastElement.style.borderColor = "rgba(239, 68, 68, 0.35)";
        toastElement.style.boxShadow = "0 18px 32px rgba(239, 68, 68, 0.25)";
      }

      toastContainer.appendChild(toastElement);

      setTimeout(() => {
        toastElement.style.opacity = "0";
        toastElement.style.transform = "translateY(6px)";
        setTimeout(() => toastElement.remove(), 320);
      }, 6200);
    };

    const showSpinner = () => spinner.classList.remove("hidden");
    const hideSpinner = () => spinner.classList.add("hidden");

    const showAuthScreen = () => {
      document.body.classList.add("auth-mode");
      authScreen.hidden = false;
      dashboardElement.hidden = true;
      hideSpinner();
      authForm?.reset();
      setTimeout(() => accessInput?.focus(), 120);
    };

    const enterDashboard = () => {
      document.body.classList.remove("auth-mode");
      authScreen.hidden = true;
      dashboardElement.hidden = false;
      loadDashboard();
    };

    const logoutUser = () => {
      sessionStorage.removeItem("orygen-auth");
      dashboardLoaded = false;
      toast("Sesión cerrada", "Ingrese el código para volver a acceder.");
      showAuthScreen();
    };

    const parseSheetNumber = (value) => {
      if (value === null || value === undefined) return null;
      if (typeof value === "number") {
        return value <= 1 && value >= 0 ? value * 100 : value;
      }
      const numeric = parseFloat(String(value).replace(/[%\s]/g, "").replace(",", "."));
      if (Number.isFinite(numeric)) {
        return numeric <= 1 ? numeric * 100 : numeric;
      }
      return null;
    };

    const formatPercentage = (value) => {
      if (value === null || Number.isNaN(value)) return "—";
      return `${value.toFixed(1)}%`;
    };

    const buildTableHead = () => {
      const head = document.getElementById("table-head");
      head.innerHTML = `
        <tr>
          <th>N°</th>
          <th>Entregable</th>
          <th>Plazo / Periodicidad</th>
          <th>Referencia contractual</th>
          <th>Acceso</th>
          <th>Cumplimiento promedio</th>
        </tr>
      `;
    };

    const buildTableBody = (rows) => {
      const body = document.getElementById("table-body");
      body.innerHTML = rows.map(row => {
        const hasAverage = Number.isFinite(row.average);
        const progress = hasAverage ? row.average : 0;
        const progressClass = hasAverage
          ? (progress >= 85 ? "var(--success)" : progress >= 60 ? "var(--warning)" : "var(--danger)")
          : "rgba(148, 163, 184, 0.35)";
        return `
          <tr>
            <td>${row.number ?? "—"}</td>
            <td>
              <strong>${row.deliverable || "Sin nombre"}</strong>
            </td>
            <td>${row.deadline || "Sin plazo"}</td>
            <td>${row.contractSection || "—"}</td>
            <td>
              ${row.folderLink ? `<a class="link-button" href="${row.folderLink}" target="_blank" rel="noopener">Abrir carpeta</a>` : "—"}
            </td>
            <td>
              <div>${formatPercentage(row.average)}</div>
              <div class="progress" aria-hidden="true">
                <div class="progress-bar" style="width:${hasAverage ? Math.min(progress, 100) : 0}%; background:${progressClass};"></div>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    };

    const buildMetricsCards = (monthlyAverages, overallAverage, rowsWithDataCount, rows) => {
      const container = document.getElementById("metrics-cards");
      const alertsContainer = document.getElementById("alerts-cards");
      const cards = [];
      const alertCards = [];

      cards.push(`
        <article class="summary-card">
          <h3>Cumplimiento global</h3>
          <div class="value">${formatPercentage(overallAverage)}</div>
          <div class="trend">${rowsWithDataCount} entregables con datos</div>
        </article>
      `);

      monthlyAverages.slice(0, 3).forEach(({ month, value, count }) => {
        cards.push(`
          <article class="summary-card">
            <h3>${month}</h3>
            <div class="value">${formatPercentage(value)}</div>
            <div class="trend">${count} registros válidos</div>
          </article>
        `);
      });

      container.innerHTML = cards.join("");

      const rowsBelowTarget = rows.filter(row => Number.isFinite(row.average) && row.average < 100);
      if (rowsBelowTarget.length) {
        const listItems = rowsBelowTarget.map(row => {
          const delta = 100 - row.average;
          return `
            <li>
              <strong>${row.deliverable ?? "Sin nombre"}</strong>
              <span>${formatPercentage(row.average)} · Falta ${formatPercentage(delta)}</span>
            </li>
          `;
        }).join("");

        alertCards.push(`
          <article class="summary-card alert">
            <h3>Entregables bajo objetivo</h3>
            <div class="value">${rowsBelowTarget.length}</div>
            <div class="trend">Revisar pendientes</div>
            <ul class="alert-list">${listItems}</ul>
          </article>
        `);
      }

      alertsContainer.innerHTML = alertCards.join("");
    };

    const buildHistogram = (months, monthlyAverages, monthlyAverageMap) => {
      const baseMonths = months.slice(0, 6);

      const filled = baseMonths.map((month) => {
        const entry = monthlyAverageMap.get(normalizeLabel(month));
        const hasData = entry && entry.value !== null && Number.isFinite(entry.value);
        return {
          month,
          value: hasData ? Number(entry.value) : 0,
          hasData
        };
      });

      const labels = filled.map(item => item.month);
      const data = filled.map(item => Number(item.value.toFixed(2)));

      const ctx = document.getElementById("histogramChart").getContext("2d");
      if (histogramChart) {
        histogramChart.destroy();
      }

      histogramChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Cumplimiento promedio (%)",
            data,
            customData: filled,
            backgroundColor: filled.map((item, idx) => {
              const base = 0.35 + (idx / Math.max(labels.length - 1, 1)) * 0.25;
              const alpha = item.hasData ? base + 0.35 : 0.22;
              return `rgba(249, 115, 22, ${alpha.toFixed(2)})`;
            }),
            borderRadius: 14,
            borderSkipped: false,
            barPercentage: 0.65,
            categoryPercentage: 0.55
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              grid: {
                color: "rgba(148, 163, 184, 0.12)"
              },
              ticks: {
                color: "rgba(226, 232, 240, 0.78)",
                font: {
                  size: 10
                }
              }
            },
            y: {
              beginAtZero: true,
              suggestedMax: 100,
              grid: {
                color: "rgba(148, 163, 184, 0.12)"
              },
              ticks: {
                color: "rgba(226, 232, 240, 0.78)",
                font: {
                  size: 10
                },
                callback: (val) => `${val}%`
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: "rgba(226, 232, 240, 0.78)",
                font: {
                  size: 10
                }
              }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const meta = context.dataset.customData?.[context.dataIndex];
                  if (!meta?.hasData) {
                    return "Sin datos registrados";
                  }
                  return `${context.parsed.y.toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    };

    const processData = (rawData) => {
      const match = rawData.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);/);
      if (!match) {
        throw new Error("No se pudo interpretar la respuesta del Google Sheet.");
      }

      const json = JSON.parse(match[1]);
      const columns = json.table.cols || [];
      const months = columns
        .slice(5)
        .map(col => (col?.label ?? "").toString().trim())
        .filter(Boolean);
      const validRows = (json.table.rows || [])
        .map(row => row.c)
        .filter(cells => Array.isArray(cells) && cells.some(cell => cell && cell.v !== null));

      if (!validRows.length) {
        throw new Error("No se encontraron filas válidas en la hoja.");
      }

      const parsedRows = validRows.map((cells) => {
        const byIndex = (index) => cells[index]?.v ?? null;
        const monthly = {};

        months.forEach((month, idx) => {
          const cell = cells[5 + idx] ?? null;
          const value = parseSheetNumber(cell?.v ?? cell?.f ?? null);
          if (value !== null && Number.isFinite(value)) {
            monthly[month] = value;
          }
        });

        const monthValues = Object.values(monthly);
        const average = monthValues.length ? monthValues.reduce((sum, v) => sum + v, 0) / monthValues.length : null;

        return {
          number: byIndex(0),
          deliverable: byIndex(1),
          deadline: byIndex(2),
          contractSection: byIndex(3),
          folderLink: byIndex(4),
          monthly,
          average
        };
      }).filter(row =>
        row.number !== null ||
        row.deliverable ||
        Object.keys(row.monthly).length
      );

      const monthlyAverages = months.map((month) => {
        const values = parsedRows
          .map(row => row.monthly[month])
          .filter(value => value !== null && value !== undefined && Number.isFinite(value));
        return {
          month,
          key: normalizeLabel(month),
          value: values.length ? values.reduce((sum, v) => sum + v, 0) / values.length : null,
          count: values.length
        };
      });

      const monthlyAverageMap = new Map(
        monthlyAverages
          .filter(item => item.key)
          .map(item => [item.key, item])
      );

      const averages = parsedRows
        .map(row => row.average)
        .filter(value => value !== null && value !== undefined && Number.isFinite(value));

      const overallAverage = averages.length ? averages.reduce((sum, v) => sum + v, 0) / averages.length : null;

      return {
        months,
        rows: parsedRows,
        monthlyAverages,
        monthlyAverageMap,
        overallAverage
      };
    };

    const renderDashboard = ({ months, rows, monthlyAverages, monthlyAverageMap, overallAverage }) => {
      const rowsWithDataCount = rows.filter(row => Number.isFinite(row.average)).length;
      buildTableHead();
      buildTableBody(rows);
      buildMetricsCards(monthlyAverages, overallAverage, rowsWithDataCount, rows);
      buildHistogram(months, monthlyAverages, monthlyAverageMap);
    };

    const loadDashboard = async () => {
      if (dashboardLoaded) return;
      showSpinner();
      try {
        const response = await fetch(SHEET_ENDPOINT);
        if (!response.ok) {
          throw new Error(`Error al solicitar la hoja: ${response.status}`);
        }
        const text = await response.text();
        const data = processData(text);
        renderDashboard(data);
        dashboardLoaded = true;
        toast("Dashboard listo", "Los datos del servicio se cargaron correctamente.", "success");
      } catch (error) {
        console.error(error);
        toast("Error al cargar", error.message || "No se pudieron obtener los datos del Google Sheet.", "error");
        dashboardLoaded = false;
      } finally {
        hideSpinner();
      }
    };

    authForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      const value = accessInput?.value.trim();
      if (value === ACCESS_CODE) {
        sessionStorage.setItem("orygen-auth", "1");
        toast("Acceso concedido", "Bienvenido al panel de control.", "success");
        enterDashboard();
      } else {
        toast("Código inválido", "Verifique el código e intente nuevamente.", "error");
        if (accessInput) {
          accessInput.value = "";
          accessInput.focus();
        }
      }
    });

    logoutButton?.addEventListener("click", (event) => {
      event.preventDefault();
      logoutUser();
    });

    document.addEventListener("DOMContentLoaded", () => {
      const isAuthenticated = sessionStorage.getItem("orygen-auth") === "1";
      if (isAuthenticated) {
        enterDashboard();
      } else {
        showAuthScreen();
      }
    });
  </script>
</body>
</html>





